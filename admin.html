<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beheerderspaneel - Minivoetbal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ff88;
            --secondary: #7c3aed;
            --dark: #0a0a0f;
            --darker: #050507;
            --light: #ffffff;
            --warning: #fbbf24;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a0a2f 100%);
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 255, 136, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .login-card {
            background: var(--dark);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 3rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .login-input {
            padding: 1rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        .login-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .header {
            padding: 2rem;
            text-align: center;
            position: relative;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--danger) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(239, 68, 68, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(0, 255, 136, 0.5)); }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .github-setup {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .github-setup h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--light);
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .match-score-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
        }

        .score-input {
            text-align: center;
        }

        .score-input label {
            display: block;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .score-input input {
            width: 100%;
            padding: 1rem;
            background: var(--darker);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: var(--light);
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .score-vs {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
        }

        .github-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 10px;
            display: none;
        }

        .github-status.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
            display: block;
        }

        .github-status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            display: block;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .success-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .success-message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .control-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .control-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .control-card h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 15px;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            width: 100%;
            margin: 0.5rem 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--light);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            width: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--light);
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--primary);
        }

        .match-summary {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .summary-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .player-attendance {
            display: grid;
            gap: 1rem;
        }

        .player-card {
            background: var(--glass);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card.status-present {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .player-card.status-absent {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .player-card.status-sitout {
            border-color: var(--warning);
            background: rgba(251, 191, 36, 0.1);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .player-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--light);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--glass-border);
            transition: all 0.3s ease;
        }

        .player-card.status-present .status-indicator {
            background: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .player-card.status-absent .status-indicator {
            background: var(--danger);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .player-card.status-sitout .status-indicator {
            background: var(--warning);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .attendance-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .attendance-btn {
            padding: 0.8rem;
            border: 2px solid transparent;
            border-radius: 10px;
            background: var(--glass);
            color: var(--light);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .attendance-btn:hover {
            transform: translateY(-2px);
        }

        .attendance-btn.btn-present {
            border-color: var(--success);
            color: var(--success);
        }

        .attendance-btn.btn-present.active {
            background: var(--success);
            color: var(--dark);
        }

        .attendance-btn.btn-absent {
            border-color: var(--danger);
            color: var(--danger);
        }

        .attendance-btn.btn-absent.active {
            background: var(--danger);
            color: var(--light);
        }

        .attendance-btn.btn-sitout {
            border-color: var(--warning);
            color: var(--warning);
        }

        .attendance-btn.btn-sitout.active {
            background: var(--warning);
            color: var(--dark);
        }

        .stats-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .stat-input {
            text-align: center;
        }

        .stat-input label {
            display: block;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-input input {
            width: 100%;
            padding: 0.8rem;
            background: var(--darker);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--light);
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .stat-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .squad-list {
            display: grid;
            gap: 1rem;
        }

        .squad-player {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .player-stats {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .match-history {
            display: grid;
            gap: 1rem;
        }

        .match-item {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .match-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--light);
        }

        .match-stats {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .stats-debug {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stats-debug h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--warning);
        }

        .debug-player {
            background: var(--darker);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .debug-player h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .debug-stats {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .match-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .attendance-buttons {
                grid-template-columns: 1fr;
            }
            
            .squad-player, .match-item {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h2 class="login-title">Beheerder Inloggen</h2>
            <div class="login-form">
                <input 
                    type="text" 
                    id="username" 
                    placeholder="Gebruikersnaam" 
                    class="login-input" 
                    required
                >
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Wachtwoord" 
                    class="login-input" 
                    required
                >
                <button type="button" class="login-btn" onclick="handleLogin()">Inloggen</button>
                <div class="login-error" id="loginError">Onjuiste inloggegevens</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <header class="header">
            <h1>Beheerderspaneel</h1>
            <p class="subtitle">Minivoetbal Management • Seizoen 2025</p>
        </header>

        <div class="container">
            <!-- GitHub Setup Section -->
            <div class="github-setup">
                <h3>⚙️ GitHub Configuratie</h3>
                <div class="form-group">
                    <label for="githubToken">GitHub Personal Access Token:</label>
                    <input type="password" id="githubToken" placeholder="Voer je GitHub token in">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="repoOwner">Repository Owner:</label>
                        <input type="text" id="repoOwner" value="lodeai" placeholder="bijv. jouwgebruikersnaam">
                    </div>
                    <div class="form-group">
                        <label for="repoName">Repository Name:</label>
                        <input type="text" id="repoName" value="vodewinste" placeholder="bijv. vodewinste">
                    </div>
                </div>
                <button onclick="testGitHubConnection()" class="btn">🔗 Test Verbinding</button>
                <button onclick="recalculateAllStats()" class="btn btn-secondary">🔄 Herbereken Statistieken</button>
                <div id="githubStatus" class="github-status"></div>
            </div>

            <!-- Debug Stats Section (can be hidden in production) -->
            <div class="stats-debug" id="statsDebug" style="display: none;">
                <h3>🐛 Statistieken Debug</h3>
                <div id="debugContent">
                    <!-- Debug info will be populated here -->
                </div>
                <button onclick="showDebugStats()" class="btn btn-secondary btn-small">Toon Debug Info</button>
            </div>

            <div class="success-message" id="successMessage">
                Actie succesvol voltooid!
            </div>

            <div class="admin-controls">
                <div class="control-card">
                    <h3>🏆 Wedstrijdenbeheer</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">Wedstrijdresultaten en spelersstatistieken vastleggen</p>
                    <button class="btn" onclick="showRecordMatchModal()">Nieuwe wedstrijd vastleggen</button>
                    <button class="btn btn-secondary" onclick="showMatchHistoryModal()">Wedstrijdgeschiedenis bekijken</button>
                </div>
                
                <div class="control-card">
                    <h3>👥 Teambeheer</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">Spelers toevoegen, verwijderen en beheren</p>
                    <button class="btn" onclick="showAddPlayerModal()">Speler toevoegen</button>
                    <button class="btn btn-secondary" onclick="showManageSquadModal()">Team beheren</button>
                </div>
            </div>
        </div>

        <!-- Record Match Modal -->
        <div class="modal" id="recordMatchModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Wedstrijd vastleggen</h3>
                    <button class="close-btn" onclick="closeModal('recordMatchModal')">&times;</button>
                </div>
                
                <div class="form-group">
                    <label>Wedstrijddatum</label>
                    <input type="date" id="matchDate">
                </div>

                <!-- Match Score Section -->
                <div class="form-group">
                    <label>Eindresultaat</label>
                    <div class="match-score-inputs">
                        <div class="score-input">
                            <label>Ons Team</label>
                            <input type="number" id="teamGoals" min="0" value="0" onchange="updateMatchSummary()">
                        </div>
                        <div class="score-vs">VS</div>
                        <div class="score-input">
                            <label>Tegenstander</label>
                            <input type="number" id="opponentGoals" min="0" value="0" onchange="updateMatchSummary()">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Opmerkingen (optioneel)</label>
                    <textarea id="matchNotes" rows="2" placeholder="Wedstrijdnotities, tegenstander naam, bijzonderheden..."></textarea>
                </div>
                
                <!-- Match Summary -->
                <div class="match-summary" id="matchSummary">
                    <div class="summary-item">
                        <div class="summary-label">Individuele Doelpunten</div>
                        <div class="summary-value" id="totalGoals">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Assists</div>
                        <div class="summary-value" id="totalAssists">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Doelpuntensaldo</div>
                        <div class="summary-value" id="goalDifference">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Sit-Outs</div>
                        <div class="summary-value" id="totalSitouts">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Geel</div>
                        <div class="summary-value" id="totalYellow">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Rood</div>
                        <div class="summary-value" id="totalRed">0</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Speleraanwezigheid & Statistieken</label>
                    <div id="noPlayersMessage" class="no-data" style="display: none;">
                        <p>Geen spelers in team. Voeg eerst spelers toe voordat je wedstrijden vastlegt.</p>
                    </div>
                    <div class="player-attendance" id="playerAttendance">
                        <!-- Players will be dynamically added here -->
                    </div>
                </div>
                
                <button class="btn" id="saveMatchBtn" onclick="recordMatch()">Wedstrijd opslaan</button>
            </div>
        </div>

        <!-- Add Player Modal -->
        <div class="modal" id="addPlayerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Nieuwe speler toevoegen</h3>
                    <button class="close-btn" onclick="closeModal('addPlayerModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label for="playerName">Spelernaam</label>
                    <input type="text" id="playerName" placeholder="Voer spelernaam in">
                </div>
                <button class="btn" onclick="addPlayer()">Speler toevoegen</button>
            </div>
        </div>

        <!-- Manage Squad Modal -->
        <div class="modal" id="manageSquadModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Team beheren</h3>
                    <button class="close-btn" onclick="closeModal('manageSquadModal')">&times;</button>
                </div>
                <div class="squad-list" id="squadList">
                    <!-- Squad will be populated here -->
                </div>
            </div>
        </div>

        <!-- Match History Modal -->
        <div class="modal" id="matchHistoryModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Wedstrijdgeschiedenis</h3>
                    <button class="close-btn" onclick="closeModal('matchHistoryModal')">&times;</button>
                </div>
                <div class="match-history" id="matchHistoryList">
                    <!-- Match history will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let teamData = {
            players: [],
            matches: [],
            lastUpdated: null
        };

        let gitHubSettings = {
            token: '',
            owner: 'lodeai',
            repo: 'vodewinste'
        };

        let currentEditingMatch = null;

        // Set today's date as default on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('matchDate').value = new Date().toISOString().split('T')[0];
        });

        // Simple authentication with base64 encoding
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Encoded credentials (base64)
            const encodedUsername = 'YWRtaW4=';
            const encodedPassword = 'd3VzdGU='; 
            
            // Encode input values for comparison
            const inputUsername = btoa(username);
            const inputPassword = btoa(password);
            
            if (inputUsername === encodedUsername && inputPassword === encodedPassword) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                sessionStorage.setItem('minivoetbalAuth', 'authenticated');
                loadGitHubSettings();
                loadData();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }

        // GitHub functions
        function loadGitHubSettings() {
            const settings = localStorage.getItem('minivoetbalGitHubSettings');
            if (settings) {
                gitHubSettings = JSON.parse(settings);
                document.getElementById('githubToken').value = gitHubSettings.token;
                document.getElementById('repoOwner').value = gitHubSettings.owner;
                document.getElementById('repoName').value = gitHubSettings.repo;
            }
        }

        function saveGitHubSettings() {
            gitHubSettings = {
                token: document.getElementById('githubToken').value,
                owner: document.getElementById('repoOwner').value,
                repo: document.getElementById('repoName').value
            };
            localStorage.setItem('minivoetbalGitHubSettings', JSON.stringify(gitHubSettings));
        }

        async function testGitHubConnection() {
            saveGitHubSettings();
            
            try {
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.owner}/${gitHubSettings.repo}`, {
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                    }
                });

                const statusElement = document.getElementById('githubStatus');
                
                if (response.ok) {
                    statusElement.className = 'github-status success';
                    statusElement.textContent = '✅ GitHub verbinding succesvol! Repository gevonden.';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                const statusElement = document.getElementById('githubStatus');
                statusElement.className = 'github-status error';
                statusElement.textContent = `❌ Verbinding mislukt: ${error.message}`;
            }
        }

        async function loadData() {
            try {
                const response = await fetch(`https://api.github.com/repos/${gitHubSettings.owner}/${gitHubSettings.repo}/contents/data.json`, {
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                    }
                });
        
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    teamData = { ...teamData, ...content };
                    
                    // Ensure all players have proper stats structure
                    teamData.players.forEach(player => {
                        if (!player.stats) {
                            player.stats = {
                                matches: 0,
                                goals: 0,
                                assists: 0,
                                yellowCards: 0,
                                redCards: 0,
                                sitOuts: 0,
                                attendance: 0
                            };
                        }
                        // Add attendance field if missing
                        if (player.stats.attendance === undefined) {
                            player.stats.attendance = 0;
                        }
                        // Add sitOuts field if missing
                        if (player.stats.sitOuts === undefined) {
                            player.stats.sitOuts = 0;
                        }
                    });
                    
                    console.log('Data loaded from GitHub:', teamData);
                    // Recalculate stats to ensure consistency
                    recalculateAllStats(false);
                } else if (response.status === 404) {
                    console.log('No existing data file found, starting fresh');
                } else {
                    throw new Error(`Failed to load data: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Fout bij laden van data. Controleer GitHub instellingen.', 'error');
            }
        }

        function showMatchHistoryModal() {
            const matchHistoryList = document.getElementById('matchHistoryList');
            
            if (teamData.matches.length === 0) {
                matchHistoryList.innerHTML = '<div class="no-data"><p>Nog geen wedstrijden gespeeld.</p></div>';
            } else {
                matchHistoryList.innerHTML = teamData.matches
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(match => {
                        const presentPlayers = match.players.filter(p => p.attendance === 'present').length;
                        const sitOutPlayers = match.players.filter(p => p.attendance === 'sitout').length;
                        const totalGoals = match.players.reduce((sum, p) => sum + (p.stats?.goals || 0), 0);
                        const totalAssists = match.players.reduce((sum, p) => sum + (p.stats?.assists || 0), 0);
                        
                        return `
                            <div class="match-item">
                                <div class="match-info">
                                    <div class="match-date">${new Date(match.date).toLocaleDateString('nl-NL')}</div>
                                    <div class="match-stats">
                                        Resultaat: ${match.teamGoals}-${match.opponentGoals} • 
                                        Saldo: ${match.goalDifference > 0 ? '+' : ''}${match.goalDifference} • 
                                        ${presentPlayers} gespeeld, ${sitOutPlayers} sit-out • 
                                        ${totalGoals} goals, ${totalAssists} assists
                                        ${match.notes ? ` • ${match.notes}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-small" onclick="editMatch(${match.id})">
                                        Bewerken
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="removeMatch(${match.id})">
                                        Verwijderen
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
            }
            
            showModal('matchHistoryModal');
        }

        // UPDATED: Remove match function with proper stat recalculation
        function removeMatch(matchId) {
            if (confirm('Weet je zeker dat je deze wedstrijd wilt verwijderen? Dit kan niet ongedaan gemaakt worden.')) {
                // Remove match from data
                teamData.matches = teamData.matches.filter(m => m.id !== matchId);
                
                // Recalculate all stats from remaining matches
                recalculateAllStats(false);
                
                saveData();
                showMatchHistoryModal();
                showMessage('Wedstrijd verwijderd!');
            }
        }

        // Allow Enter key to submit login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                handleLogin();
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Check if user is already logged in
        if (sessionStorage.getItem('minivoetbalAuth') === 'authenticated') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadGitHubSettings();
            loadData();
        }
        
} else if (response.status === 404) {
                    console.log('No existing data file found, starting fresh');
                } else {
                    throw new Error(`Failed to load data: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Fout bij laden van data. Controleer GitHub instellingen.', 'error');
            }
        }

        async function saveData() {
            try {
                saveGitHubSettings();
                teamData.lastUpdated = new Date().toISOString();

                // Get current file to get SHA for update
                let sha = null;
                try {
                    const response = await fetch(`https://api.github.com/repos/${gitHubSettings.owner}/${gitHubSettings.repo}/contents/data.json`, {
                        headers: {
                            'Authorization': `token ${gitHubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                        }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    // File might not exist yet
                }

                const content = btoa(JSON.stringify(teamData, null, 2));
                const body = {
                    message: `Update team data - ${new Date().toLocaleDateString('nl-NL')}`,
                    content: content
                };

                if (sha) {
                    body.sha = sha;
                }

                const saveResponse = await fetch(`https://api.github.com/repos/${gitHubSettings.owner}/${gitHubSettings.repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${gitHubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (saveResponse.ok) {
                    showMessage('Data succesvol opgeslagen!');
                } else {
                    throw new Error(`Save failed: ${saveResponse.status}`);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showMessage('Fout bij opslaan van data. Controleer GitHub instellingen.', 'error');
            }
        }

        // NEW: Function to recalculate all player statistics from match data
        function recalculateAllStats(showConfirmation = true) {
            console.log('Recalculating all player statistics...');
            
            // Reset all player stats
            teamData.players.forEach(player => {
                player.stats = {
                    matches: 0,
                    goals: 0,
                    assists: 0,
                    yellowCards: 0,
                    redCards: 0,
                    sitOuts: 0,
                    attendance: 0
                };
            });

            // Recalculate from all matches
            teamData.matches.forEach(match => {
                match.players.forEach(matchPlayer => {
                    const player = teamData.players.find(p => p.id === matchPlayer.id);
                    if (player) {
                        // Count total matches (present + sitout)
                        if (matchPlayer.attendance === 'present') {
                            player.stats.matches++;
                            player.stats.attendance++;
                            player.stats.goals += matchPlayer.stats.goals || 0;
                            player.stats.assists += matchPlayer.stats.assists || 0;
                            player.stats.yellowCards += matchPlayer.stats.yellowCards || 0;
                            player.stats.redCards += matchPlayer.stats.redCards || 0;
                        } else if (matchPlayer.attendance === 'sitout') {
                            player.stats.matches++;
                            player.stats.sitOuts++;
                        }
                        // absent players don't get any stats incremented
                    }
                });
            });

            console.log('Statistics recalculated:', teamData.players);
            
            if (showConfirmation) {
                showMessage('Alle statistieken herberekend!');
                saveData(); // Auto-save after recalculation
            }
        }

        // NEW: Debug function to show detailed stats calculation
        function showDebugStats() {
            const debugContent = document.getElementById('debugContent');
            const statsDebug = document.getElementById('statsDebug');
            
            let debugHtml = '';
            
            teamData.players.forEach(player => {
                debugHtml += `
                    <div class="debug-player">
                        <h4>${player.name}</h4>
                        <div class="debug-stats">
                            <strong>Totale Wedstrijden:</strong> ${player.stats.matches}<br>
                            <strong>Aanwezigheid (gespeeld):</strong> ${player.stats.attendance}<br>
                            <strong>Sit-outs:</strong> ${player.stats.sitOuts}<br>
                            <strong>Doelpunten:</strong> ${player.stats.goals}<br>
                            <strong>Assists:</strong> ${player.stats.assists}<br>
                            <strong>Gele kaarten:</strong> ${player.stats.yellowCards}<br>
                            <strong>Rode kaarten:</strong> ${player.stats.redCards}<br>
                            <hr style="margin: 0.5rem 0; border-color: var(--glass-border);">
                            <strong>Match Details:</strong><br>
                `;
                
                teamData.matches.forEach((match, index) => {
                    const matchPlayer = match.players.find(mp => mp.id === player.id);
                    if (matchPlayer) {
                        debugHtml += `Match ${index + 1} (${match.date}): ${matchPlayer.attendance}`;
                        if (matchPlayer.attendance === 'present' && matchPlayer.stats) {
                            debugHtml += ` - ${matchPlayer.stats.goals}G, ${matchPlayer.stats.assists}A, ${matchPlayer.stats.yellowCards}Y, ${matchPlayer.stats.redCards}R`;
                        }
                        debugHtml += '<br>';
                    } else {
                        debugHtml += `Match ${index + 1} (${match.date}): not recorded<br>`;
                    }
                });
                
                debugHtml += '</div></div>';
            });
            
            debugContent.innerHTML = debugHtml;
            statsDebug.style.display = 'block';
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showMessage(message, type = 'success') {
            const messageElement = document.getElementById('successMessage');
            messageElement.textContent = message;
            messageElement.className = `success-message${type === 'error' ? ' error' : ''}`;
            messageElement.classList.add('show');
            
            setTimeout(() => {
                messageElement.classList.remove('show');
            }, 3000);
        }

        // Player management
        function showAddPlayerModal() {
            document.getElementById('playerName').value = '';
            showModal('addPlayerModal');
        }

        function addPlayer() {
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!playerName) {
                alert('Voer een spelernaam in');
                return;
            }

            if (teamData.players.find(p => p.name.toLowerCase() === playerName.toLowerCase())) {
                alert('Deze speler bestaat al in het team');
                return;
            }

            const newPlayer = {
                id: Date.now(),
                name: playerName,
                stats: {
                    matches: 0,
                    goals: 0,
                    assists: 0,
                    yellowCards: 0,
                    redCards: 0,
                    sitOuts: 0,
                    attendance: 0
                }
            };

            teamData.players.push(newPlayer);
            saveData();
            closeModal('addPlayerModal');
            showMessage(`Speler "${playerName}" toegevoegd!`);
        }

        function removePlayer(playerId) {
            if (confirm('Weet je zeker dat je deze speler wilt verwijderen? Dit verwijdert ook alle wedstrijddata van deze speler.')) {
                // Remove player from all matches
                teamData.matches.forEach(match => {
                    match.players = match.players.filter(p => p.id !== playerId);
                });
                
                // Remove player from team
                teamData.players = teamData.players.filter(p => p.id !== playerId);
                
                saveData();
                showManageSquadModal();
                showMessage('Speler verwijderd!');
            }
        }

        function showManageSquadModal() {
            const squadList = document.getElementById('squadList');
            
            if (teamData.players.length === 0) {
                squadList.innerHTML = '<div class="no-data"><p>Geen spelers in team. Voeg eerst spelers toe.</p></div>';
            } else {
                squadList.innerHTML = teamData.players.map(player => `
                    <div class="squad-player">
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">
                                ${player.stats.matches} wedstrijden • ${player.stats.attendance} gespeeld • ${player.stats.sitOuts} sit-outs • ${player.stats.goals} goals • ${player.stats.assists} assists
                            </div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="removePlayer(${player.id})">
                            Verwijderen
                        </button>
                    </div>
                `).join('');
            }
            
            showModal('manageSquadModal');
        }

        // Reset match modal to default state
        function resetMatchModal() {
            document.querySelector('#recordMatchModal .modal-title').textContent = 'Wedstrijd vastleggen';
            document.getElementById('saveMatchBtn').textContent = 'Wedstrijd opslaan';
            document.getElementById('saveMatchBtn').onclick = recordMatch;
            currentEditingMatch = null;
            
            // Reset form fields
            document.getElementById('matchDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('teamGoals').value = '0';
            document.getElementById('opponentGoals').value = '0';
            document.getElementById('matchNotes').value = '';
        }

        // Match management
        function showRecordMatchModal() {
            resetMatchModal();
            
            const playerAttendance = document.getElementById('playerAttendance');
            
            if (teamData.players.length === 0) {
                document.getElementById('noPlayersMessage').style.display = 'block';
                playerAttendance.innerHTML = '';
            } else {
                document.getElementById('noPlayersMessage').style.display = 'none';
                playerAttendance.innerHTML = teamData.players.map(player => `
                    <div class="player-card" id="player-${player.id}">
                        <div class="player-header">
                            <div class="player-name">${player.name}</div>
                            <div class="status-indicator"></div>
                        </div>
                        
                        <div class="attendance-buttons">
                            <button class="attendance-btn btn-present" onclick="setAttendance(${player.id}, 'present')">
                                Aanwezig
                            </button>
                            <button class="attendance-btn btn-absent" onclick="setAttendance(${player.id}, 'absent')">
                                Afwezig
                            </button>
                            <button class="attendance-btn btn-sitout" onclick="setAttendance(${player.id}, 'sitout')">
                                Sit-Out
                            </button>
                        </div>
                        
                        <div class="stats-inputs" id="stats-${player.id}" style="display: none;">
                            <div class="stat-input">
                                <label>Goals</label>
                                <input type="number" min="0" value="0" onchange="updateMatchSummary()">
                            </div>
                            <div class="stat-input">
                                <label>Assists</label>
                                <input type="number" min="0" value="0" onchange="updateMatchSummary()">
                            </div>
                            <div class="stat-input">
                                <label>Geel</label>
                                <input type="number" min="0" value="0" onchange="updateMatchSummary()">
                            </div>
                            <div class="stat-input">
                                <label>Rood</label>
                                <input type="number" min="0" value="0" onchange="updateMatchSummary()">
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            updateMatchSummary();
            showModal('recordMatchModal');
        }

        function setAttendance(playerId, status) {
            const playerCard = document.getElementById(`player-${playerId}`);
            const statsInputs = document.getElementById(`stats-${playerId}`);
            const buttons = playerCard.querySelectorAll('.attendance-btn');
            
            // Remove all active states and status classes
            buttons.forEach(btn => btn.classList.remove('active'));
            playerCard.className = 'player-card';
            
            // Set new status
            playerCard.classList.add(`status-${status}`);
            playerCard.querySelector(`.btn-${status}`).classList.add('active');
            
            // Show/hide stats inputs
            if (status === 'present') {
                statsInputs.style.display = 'grid';
            } else {
                statsInputs.style.display = 'none';
                // Reset stats inputs
                statsInputs.querySelectorAll('input').forEach(input => input.value = '0');
            }
            
            updateMatchSummary();
        }

        function updateMatchSummary() {
            let totalGoals = 0;
            let totalAssists = 0;
            let totalSitouts = 0;
            let totalYellow = 0;
            let totalRed = 0;

            // Calculate individual player stats
            teamData.players.forEach(player => {
                const playerCard = document.getElementById(`player-${player.id}`);
                if (playerCard && playerCard.classList.contains('status-present')) {
                    const statsInputs = document.getElementById(`stats-${player.id}`);
                    const inputs = statsInputs.querySelectorAll('input');
                    totalGoals += parseInt(inputs[0].value) || 0;
                    totalAssists += parseInt(inputs[1].value) || 0;
                    totalYellow += parseInt(inputs[2].value) || 0;
                    totalRed += parseInt(inputs[3].value) || 0;
                } else if (playerCard && playerCard.classList.contains('status-sitout')) {
                    totalSitouts++;
                }
            });

            // Calculate goal difference
            const teamGoals = parseInt(document.getElementById('teamGoals').value) || 0;
            const opponentGoals = parseInt(document.getElementById('opponentGoals').value) || 0;
            const goalDifference = teamGoals - opponentGoals;

            // Update summary
            document.getElementById('totalGoals').textContent = totalGoals;
            document.getElementById('totalAssists').textContent = totalAssists;
            document.getElementById('totalSitouts').textContent = totalSitouts;
            document.getElementById('totalYellow').textContent = totalYellow;
            document.getElementById('totalRed').textContent = totalRed;
            document.getElementById('goalDifference').textContent = goalDifference > 0 ? `+${goalDifference}` : goalDifference;
        }

        // UPDATED: Record match function with proper stat tracking
        function recordMatch() {
            const matchDate = document.getElementById('matchDate').value;
            const teamGoals = parseInt(document.getElementById('teamGoals').value) || 0;
            const opponentGoals = parseInt(document.getElementById('opponentGoals').value) || 0;
            const matchNotes = document.getElementById('matchNotes').value;
            
            if (!matchDate) {
                alert('Selecteer een wedstrijddatum');
                return;
            }

            const matchData = {
                id: Date.now(),
                date: matchDate,
                teamGoals: teamGoals,
                opponentGoals: opponentGoals,
                goalDifference: teamGoals - opponentGoals,
                notes: matchNotes,
                players: []
            };

            // Collect player data and update player stats
            teamData.players.forEach(player => {
                const playerCard = document.getElementById(`player-${player.id}`);
                let attendance = 'absent';
                let stats = { goals: 0, assists: 0, yellowCards: 0, redCards: 0 };
                
                if (playerCard.classList.contains('status-present')) {
                    attendance = 'present';
                    const statsInputs = document.getElementById(`stats-${player.id}`);
                    const inputs = statsInputs.querySelectorAll('input');
                    stats = {
                        goals: parseInt(inputs[0].value) || 0,
                        assists: parseInt(inputs[1].value) || 0,
                        yellowCards: parseInt(inputs[2].value) || 0,
                        redCards: parseInt(inputs[3].value) || 0
                    };
                } else if (playerCard.classList.contains('status-sitout')) {
                    attendance = 'sitout';
                }

                // Add player data to match
                matchData.players.push({
                    id: player.id,
                    name: player.name,
                    attendance: attendance,
                    stats: stats
                });

                // Update player totals based on attendance
                if (attendance === 'present') {
                    player.stats.matches++;
                    player.stats.attendance++;
                    player.stats.goals += stats.goals;
                    player.stats.assists += stats.assists;
                    player.stats.yellowCards += stats.yellowCards;
                    player.stats.redCards += stats.redCards;
                } else if (attendance === 'sitout') {
                    player.stats.matches++;
                    player.stats.sitOuts++;
                }
                // Absent players: no stats updated
            });

            teamData.matches.push(matchData);
            saveData();
            closeModal('recordMatchModal');
            showMessage('Wedstrijd succesvol opgeslagen!');
        }

        // UPDATED: Edit match function
        function editMatch(matchId) {
            currentEditingMatch = teamData.matches.find(m => m.id === matchId);
            if (!currentEditingMatch) return;

            // Update modal title and button
            document.querySelector('#recordMatchModal .modal-title').textContent = 'Wedstrijd bewerken';
            document.getElementById('saveMatchBtn').textContent = 'Wijzigingen opslaan';
            document.getElementById('saveMatchBtn').onclick = updateMatch;

            // Populate form with existing match data
            document.getElementById('matchDate').value = currentEditingMatch.date;
            document.getElementById('teamGoals').value = currentEditingMatch.teamGoals;
            document.getElementById('opponentGoals').value = currentEditingMatch.opponentGoals;
            document.getElementById('matchNotes').value = currentEditingMatch.notes || '';

            // Populate player attendance and stats
            const playerAttendance = document.getElementById('playerAttendance');
            
            if (teamData.players.length === 0) {
                document.getElementById('noPlayersMessage').style.display = 'block';
                playerAttendance.innerHTML = '';
            } else {
                document.getElementById('noPlayersMessage').style.display = 'none';
                playerAttendance.innerHTML = teamData.players.map(player => {
                    const matchPlayerData = currentEditingMatch.players.find(mp => mp.id === player.id);
                    const attendance = matchPlayerData ? matchPlayerData.attendance : 'absent';
                    const stats = matchPlayerData ? matchPlayerData.stats : { goals: 0, assists: 0, yellowCards: 0, redCards: 0 };
                    
                    return `
                        <div class="player-card status-${attendance}" id="player-${player.id}">
                            <div class="player-header">
                                <div class="player-name">${player.name}</div>
                                <div class="status-indicator"></div>
                            </div>
                            
                            <div class="attendance-buttons">
                                <button class="attendance-btn btn-present ${attendance === 'present' ? 'active' : ''}" onclick="setAttendance(${player.id}, 'present')">
                                    Aanwezig
                                </button>
                                <button class="attendance-btn btn-absent ${attendance === 'absent' ? 'active' : ''}" onclick="setAttendance(${player.id}, 'absent')">
                                    Afwezig
                                </button>
                                <button class="attendance-btn btn-sitout ${attendance === 'sitout' ? 'active' : ''}" onclick="setAttendance(${player.id}, 'sitout')">
                                    Sit-Out
                                </button>
                            </div>
                            
                            <div class="stats-inputs" id="stats-${player.id}" style="display: ${attendance === 'present' ? 'grid' : 'none'};">
                                <div class="stat-input">
                                    <label>Goals</label>
                                    <input type="number" min="0" value="${stats.goals}" onchange="updateMatchSummary()">
                                </div>
                                <div class="stat-input">
                                    <label>Assists</label>
                                    <input type="number" min="0" value="${stats.assists}" onchange="updateMatchSummary()">
                                </div>
                                <div class="stat-input">
                                    <label>Geel</label>
                                    <input type="number" min="0" value="${stats.yellowCards}" onchange="updateMatchSummary()">
                                </div>
                                <div class="stat-input">
                                    <label>Rood</label>
                                    <input type="number" min="0" value="${stats.redCards}" onchange="updateMatchSummary()">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateMatchSummary();
            closeModal('matchHistoryModal');
            showModal('recordMatchModal');
        }

        // UPDATED: Update match function with proper stat recalculation
        function updateMatch() {
            if (!currentEditingMatch) return;

            const matchDate = document.getElementById('matchDate').value;
            const teamGoals = parseInt(document.getElementById('teamGoals').value) || 0;
            const opponentGoals = parseInt(document.getElementById('opponentGoals').value) || 0;
            const matchNotes = document.getElementById('matchNotes').value;
            
            if (!matchDate) {
                alert('Selecteer een wedstrijddatum');
                return;
            }

            // Update match basic data
            currentEditingMatch.date = matchDate;
            currentEditingMatch.teamGoals = teamGoals;
            currentEditingMatch.opponentGoals = opponentGoals;
            currentEditingMatch.goalDifference = teamGoals - opponentGoals;
            currentEditingMatch.notes = matchNotes;

            // Update player data for this match
            currentEditingMatch.players = [];
            teamData.players.forEach(player => {
                const playerCard = document.getElementById(`player-${player.id}`);
                let attendance = 'absent';
                let stats = { goals: 0, assists: 0, yellowCards: 0, redCards: 0 };
                
                if (playerCard.classList.contains('status-present')) {
                    attendance = 'present';
                    const statsInputs = document.getElementById(`stats-${player.id}`);
                    const inputs = statsInputs.querySelectorAll('input');
                    stats = {
                        goals: parseInt(inputs[0].value) || 0,
                        assists: parseInt(inputs[1].value) || 0,
                        yellowCards: parseInt(inputs[2].value) || 0,
                        redCards: parseInt(inputs[3].value) || 0
                    };
                } else if (playerCard.classList.contains('status-sitout')) {
                    attendance = 'sitout';
                }

                currentEditingMatch.players.push({
                    id: player.id,
                    name: player.name,
                    attendance: attendance,
                    stats: stats
                });
            });

            // Recalculate ALL stats from scratch to ensure consistency
            recalculateAllStats(false);
            
            saveData();
            closeModal('recordMatchModal');
            showMessage('Wedstrijd succesvol bijgewerkt!');
            currentEditingMatch = null;
        }

        function showMatchHistoryModal() {
            const matchHistoryList = document.getElementById('matchHistoryList');
            
            if (teamData.matches.length === 0) {
                matchHistoryList.innerHTML = '<div class="no-data"><p>Nog geen wedstrijden gespeeld.</p></div>';
            } else {
                matchHistoryList.innerHTML = teamData.matches
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(match => {
                        const presentPlayers = match.players.filter(p => p.attendance === 'present').length;
                        const sitOutPlayers = match.players.filter(p => p.attendance === 'sitout').length;
                        const totalGoals = match.players.reduce((sum, p) => sum + (p.stats?.goals || 0), 0);
                        const totalAssists = match.players.reduce((sum, p) => sum + (p.stats?.assists || 0), 0);
                        
                        return `
                            <div class="match-item">
                                <div class="match-info">
                                    <div class="match-date">${new Date(match.date).toLocaleDateString('nl-NL')}</div>
                                    <div class="match-stats">
                                        Resultaat: ${match.teamGoals}-${match.opponentGoals} • 
                                        Saldo: ${match.goalDifference > 0 ? '+' : ''}${match.goalDifference} • 
                                        ${presentPlayers} gespeeld, ${sitOutPlayers} sit-out • 
                                        ${totalGoals} goals, ${totalAssists} assists
                                        ${match.notes ? ` • ${match.notes}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-small" onclick="editMatch(${match.id})">
                                        Bewerken
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="removeMatch(${match.id})">
                                        Verwijderen
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
            }
            
            showModal('matchHistoryModal');
        }

        function removeMatch(matchId) {
            if (confirm('Weet je zeker dat je deze wedstrijd wilt verwijderen? Dit kan niet ongedaan gemaakt worden.')) {
                teamData.matches = teamData.matches.filter(m => m.id !== matchId);
                recalculateAllStats(false);
                saveData();
                showMatchHistoryModal();
                showMessage('Wedstrijd verwijderd!');
            }
        }

        // Allow Enter key to submit login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                handleLogin();
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Check if user is already logged in
        if (sessionStorage.getItem('minivoetbalAuth') === 'authenticated') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadGitHubSettings();
            loadData();
        }
    </script>
</body>
</html>
